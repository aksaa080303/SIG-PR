  <!DOCTYPE html>
  <html>
  <head>
    <title>Peta Evakuasi Tsunami - Palabuhanratu</title>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css"/>

    <style>
      body {
        font-family: "Segoe UI", sans-serif;
        margin: 0;
        background: #eef2f3;
      }
      h2 {
        text-align: center;
        background-color: #004d80;
        color: white;
        padding: 10px;
        margin: 0;
        letter-spacing: 1px;
      }
      #map {
        height: 600px;
        margin: 15px;
        border-radius: 10px;
        box-shadow: 0 0 10px rgba(0,0,0,0.3);
      }

      .legend {
        background: white;
        padding: 10px;
        border-radius: 8px;
        box-shadow: 0 0 5px rgba(0,0,0,0.3);
        line-height: 18px;
      }
      .legend i {
        width: 18px;
        height: 18px;
        float: left;
        margin-right: 8px;
        opacity: 0.8;
      }
      

      /* ===============================
        PANEL TAMBAHAN (TIDAK MENGGANGGU KODE ANDA)
        =============================== */
      #sidePanel {
        position: fixed;
        top: 80px;
        left: 20px;
        width: 260px;
        background: white;
        padding: 15px;
        border-radius: 15px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        z-index: 9999;
      }
      #sidePanel h3 {
        margin-top: 0;
        color: #004d80;
        text-align: center;
        font-size: 18px;
      }
      .infoBox {
        padding: 10px;
        border-radius: 10px;
        background: #f4f7f9;
        margin-bottom: 10px;
        border-left: 4px solid #004d80;
        font-size: 14px;
      }
    </style>
  </head>

  <body>

    <h2>Peta Evakuasi Tsunami - Palabuhanratu</h2>
    
    <!-- PANEL BARU (TIDAK MENGUBAH KODE ANDA) -->
    <div id="sidePanel">
      <h3>Informasi Lokasi</h3>

      <div class="infoBox">
        <b>Wilayah:</b> Palabuhanratu<br>
        <b>Status:</b> Zona Rawan Tsunami<br>
        <b>Fitur Peta:</b> Titik Evakuasi, Jalur, Zona Bahaya.
      </div>

      <div class="infoBox" id="warningBox">
          <b>Peringatan:</b><br>
            <span id="warningText">
             Kondisi aman.
            </span>
      </div>
      <button onclick="document.getElementById('siren').play()">
       Aktifkan Audio Peringatan
      </button>
      <button onclick="testSiren()"
        style="width:100%; padding:8px; margin-top:6px;">
        üß™ Test Sirine
        </button>



      <div class="infoBox">
        <b>Cuaca Saat Ini</b><br>
      Suhu: <span id="temp">--</span> ¬∞C<br>
      Angin: <span id="wind">--</span> km/h<br>
    </div>
      </div>

      <div id="rightPanel">
        <!-- Search -->
    <input type="text" id="searchMarker" class="searchBox" placeholder="Cari titik evakuasi...">

    <button class="btn" onclick="downloadGeoJSON()">Download Jalur</button>

    <input type="file" id="uploadGeo" style="margin-top:8px">
      </div>
    </div>

    <div id="map"></div>

    <audio id="siren" src="https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg"></audio>

    <!-- ===============================
          KODE BARU
        =============================== -->
    <script>
      var map = L.map('map').setView([-6.988, 106.548], 13);

        /* ==============================
   GPS SIMULATION VARIABLES
============================== */
      var gpsMarker = null;
      var sirenActive = false;

      var gpsPath = [];
      var gpsPolyline = L.polyline([], {
          color: "purple",
          weight: 4,
          dashArray: "5,10"
        }).addTo(map);


      var osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors'
      }).addTo(map);

      var satellite = L.tileLayer('https://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
        maxZoom: 20,
        subdomains: ['mt0','mt1','mt2','mt3'],
        attribution: '¬© Google Satellite'
      });

      var titikLayer = L.layerGroup().addTo(map);

      var iconAlun = L.icon({
        iconUrl: 'https://cdn-icons-png.flaticon.com/128/15705/15705112.png',
        iconSize: [32, 32]
      });

      var iconBPBD = L.icon({
        iconUrl: 'https://cdn-icons-png.flaticon.com/128/1518/1518379.png',
        iconSize: [32, 32]
      });

      var iconSekolah = L.icon({
        iconUrl: 'https://cdn-icons-png.flaticon.com/128/5404/5404967.png',
        iconSize: [32, 32]
      });

      var iconLapangan = L.icon({
        iconUrl: 'https://cdn-icons-png.flaticon.com/128/1202/1202941.png',
        iconSize: [32, 32]
      });

      var titikEvakuasi = [
        { name: "Titik Evakuasi 1 - Alun-Alun Palabuhanratu", coords: [-6.9881, 106.5509], icon: iconAlun },
        { name: "Titik Evakuasi 2 - BPBD Sukabumi", coords: [-6.9827, 106.5559], icon: iconBPBD },
        { name: "Titik Evakuasi 3 - SMKN 1 Palabuhanratu", coords: [-6.9771, 106.5450], icon: iconSekolah },
        { name: "Titik Evakuasi 4 - Lapang Badak Putih", coords: [-6.9844, 106.5519], icon: iconLapangan }
      ];

      var markerList = []; // untuk search

      titikEvakuasi.forEach(lokasi => {
    let m = L.marker(lokasi.coords, {icon: lokasi.icon})
      .bindTooltip(lokasi.name)
      .bindPopup(`<b>${lokasi.name}</b><br>Lokasi aman evakuasi tsunami.`)
      .addTo(titikLayer);

    markerList.push({
      name: lokasi.name,
      marker: m
    });
  });


      function buatJalurEvakuasi(coords, nama) {
        return L.polyline(coords, { color: "blue", weight: 6 })
          .bindTooltip(nama)
          .addTo(map);
      }

      var jalur1 = buatJalurEvakuasi([
        [-6.9883, 106.5509], 
        [-6.9887, 106.5508], 
        [-6.9877, 106.5448], 
        [-6.9871, 106.5437]
      ], "Jalur Evakuasi 1");

      var jalur2 = buatJalurEvakuasi([
        [-6.9833, 106.5562], [-6.9858, 106.5528], [-6.9881, 106.5509]
      ], "Jalur Evakuasi 2");

      var jalur3 = buatJalurEvakuasi([
        [-6.9770, 106.5450], [-6.9792, 106.5404], [-6.9811, 106.5395]
      ], "Jalur Evakuasi 3");

      var jalur4 = buatJalurEvakuasi([
        [-6.9858, 106.5434], [-6.9865, 106.5507], [-6.9844, 106.5519]
      ], "Jalur Evakuasi 4");

      var zonaTinggi = L.polygon([
        [-7.002916808170778, 106.54154515386834], 
        [-6.99203739068323, 106.54619170064345], 
        [-6.982952059074851, 106.54490201581638],
        [-6.978619289036541, 106.53637552444677], 
        [-6.978628287628494, 106.53116094396881],
        [-6.979718526789244, 106.53231793648953],
        [-6.981051839818244, 106.53302183767107],
        [-6.981054911842846, 106.53411672302818],
        [-6.980281215698021, 106.53562661354698],
        [-6.982131591761627, 106.53765978742244],
        [-6.986795154613375, 106.5421721492743],
        [-6.991349385470874, 106.54043605782012],
        [-6.991945210023785, 106.54154058831357],
        [-6.996449619177551, 106.54264511902178]
      ], { color: 'darkred', fillColor: 'red', fillOpacity: 0.6 }).addTo(map)
        .bindPopup("Zona Tsunami Tinggi");

      var zonaSedang = L.polygon([
        [-7.002916808170778, 106.54154515386834], 
        [-6.992420680217851, 106.54781574643445], 
        [-6.981755596875542, 106.54615809045359],
        [-6.977611907623991, 106.53651706771333],
        [-6.978628287628494, 106.53116094396881],
        [-6.978619289036541, 106.53637552444677],
        [-6.982952059074851, 106.54490201581638],
        [-6.99203739068323, 106.54619170064345]
      ], { color: 'darkorange', fillColor: 'orange', fillOpacity: 0.5 }).addTo(map)
        .bindPopup("Zona Tsunami Sedang");

      var zonaRendah = L.polygon([
        [-7.002916808170778, 106.54154515386834], 
        [-6.993263823541074, 106.54889811786467], 
        [-6.981349799141045, 106.54702447081843], 
        [-6.976943894532362, 106.53614229655251],
        [-6.978628287628494, 106.53116094396881],
        [-6.977611907623991, 106.53651706771333],
        [-6.981755596875542, 106.54615809045359],
        [-6.992420680217851, 106.54781574643445]
      ], { color: 'goldenrod', fillColor: 'yellow', fillOpacity: 0.4 }).addTo(map)
        .bindPopup("Zona Tsunami Rendah");

      var zonaSangatRendah = L.polygon([
        [-7.002916808170778, 106.54154515386834], 
        [-6.993343027564504, 106.55020366582787], 
        [-6.9811827885053725, 106.54822631480619], 
        [-6.976943894532362, 106.53614229655251],
        [-6.981349799141045, 106.54702447081843],
        [-6.993263823541074, 106.54889811786467]
      ], { color: 'green', fillColor: 'green', fillOpacity: 0.4 }).addTo(map)
        .bindPopup("Zona Tsunami Sangat Rendah");

      var baseMaps = { "OpenStreetMap": osm, "Satellite": satellite };
      var overlayMaps = {
        "Titik Evakuasi": titikLayer,
        "Jalur Evakuasi 1": jalur1,
        "Jalur Evakuasi 2": jalur2,
        "Jalur Evakuasi 3": jalur3,
        "Jalur Evakuasi 4": jalur4,
        "Zona Tsunami Tinggi": zonaTinggi,
        "Zona Tsunami Sedang": zonaSedang,
        "Zona Tsunami Rendah": zonaRendah,
        "Zona Tsunami Sangat Rendah": zonaSangatRendah
      };
      

      L.control.layers(baseMaps, overlayMaps, {collapsed:false}).addTo(map);

      var legend = L.control({position: 'bottomright'});
      legend.onAdd = function () {
        var div = L.DomUtil.create('div', 'legend');
        div.innerHTML += "<b>Tinggi Zona Tsunami</b><br>";
        div.innerHTML += '<i style="background:red"></i> Tinggi     (10 - 20M)<br>';
        div.innerHTML += '<i style="background:orange"></i> Sedang      (3 - 10M)<br>';
        div.innerHTML += '<i style="background:yellow"></i> Rendah      (0.5 - 3M)<br>';
        div.innerHTML += '<i style="background:green"></i> Sangat Rendah      (0 - 0.5M)<br>';
        return div;
      };
      
      legend.addTo(map);   // <‚Äî ini kode legenda terakhir
                      //     DI SINI kamu tempelkan fitur search!

  /* ==============================
   SIMULATED GPS API
============================== */
function getSimulatedGPS() {
  let baseLat = -6.988;
  let baseLng = 106.548;

  let randomLat = baseLat + (Math.random() - 0.5) * 0.01;
  let randomLng = baseLng + (Math.random() - 0.5) * 0.01;

  return {
    lat: randomLat,
    lng: randomLng
  };
}

/* ==============================
   UPDATE GPS MARKER
============================== */
function updateGPSMarker() {
  let gpsData = getSimulatedGPS();
  let latlng = [gpsData.lat, gpsData.lng];

  gpsPath.push(latlng);
  gpsPolyline.setLatLngs(gpsPath);

  checkDangerZone(L.latLng(latlng));


  if (gpsMarker === null) {
    gpsMarker = L.marker(latlng, {
      icon: L.icon({
        iconUrl: "https://cdn-icons-png.flaticon.com/128/684/684908.png",
        iconSize: [32, 32]
      })
    }).addTo(map)
      .bindPopup("üìç Posisi GPS (Simulasi)");
  } else {
    gpsMarker.setLatLng(latlng);
  }
}

/* ==============================
   WARNING SYSTEM
============================== */
function checkDangerZone(latlng) {
  let warningText = document.getElementById("warningText");
  let siren = document.getElementById("siren");

  let isDanger =
    zonaTinggi.getBounds().contains(latlng) ||
    zonaSedang.getBounds().contains(latlng);

  if (isDanger) {
    warningText.innerHTML =
      "<b style='color:red'>‚ö†Ô∏è TSUNAMI TERDETEKSI!</b><br>" +
      "Patuhi jalur evakuasi resmi dan segera menuju titik aman.";

    // üîä Sirine bunyi otomatis (1x)
    if (!sirenActive) {
      siren.currentTime = 0;
      siren.play();
      sirenActive = true;
    }

  } else {
    warningText.innerHTML =
      "<b style='color:green'>‚úÖ Aman</b><br>Tetap waspada.";

    // üì¥ Matikan sirine saat aman
    siren.pause();
    sirenActive = false;
  }
}



/* ==============================
   GPS INTERVAL (5 DETIK)
============================== */
setInterval(updateGPSMarker, 5000);

function testSiren() {
  let siren = document.getElementById("siren");
  siren.currentTime = 0; // ulang dari awal
  siren.play();
}




  /* ==============================
          SEARCH MARKER
  ============================== */
  document.getElementById("searchMarker").addEventListener("keyup", function () {
    let q = this.value.toLowerCase();

    markerList.forEach(m => {
      if (m.name.toLowerCase().includes(q)) {
        m.marker.openPopup();
        map.setView(m.marker.getLatLng(), 16);
      }
    });
  });

  /* ==============================
        AMBIL CUACA (Open-Meteo)
    ============================== */
    fetch("https://api.open-meteo.com/v1/forecast?latitude=-6.99&longitude=106.55&current=temperature_2m,wind_speed_10m")
      .then(r => r.json())
      .then(d => {
        document.getElementById("temp").textContent = d.current.temperature_2m;
        document.getElementById("wind").textContent = d.current.wind_speed_10m;
      });


    </script>
  </body>
  </html>
